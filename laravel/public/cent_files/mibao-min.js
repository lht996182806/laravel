OO(["com.mi.utils.Cookie","com.mi.utils.L11N"],"com.mi.passport.mibao",function(b,d,g){var e=g.$class({constructor:function(h){}});var f=g.$class({constructor:function(h){this.$form=$(h.form||h.$form);this.$selects=$(".iselect");this.typeMap={};this.questionMap={};this.ajax=!!h.ajax},uiBind:function(){$(document).delegate(".i_selectbox","click",function(){var i=$(this);i.parents("dd").removeClass("empty");i.find("dd").last().addClass("last-border");i.find(".i_selectoption").bgiframe()});if($.browser.msie&&($.browser.version=="6.0")&&!$.support.style){$(document).delegate(".i_selectoption dd","hover",function(){$(this).toggleClass("hover")})}this.$form.find(".input_kuang").bind("focus",function(i){$(i.target).closest(".dd_l").find(".error-mes").hide();$(i.target).closest(".dd_l").find(".input_bg").removeClass("error_bg")});this.$form.find(".i_selectoption dd").click(function(o,m){m=m||{};var k=$(o.target);var j=k.parent().find("dd").index(k);var l=k.closest(".login-dl");var n=l.find("select");var i=n[0];setTimeout(function(){i.selectedIndex=j;if(j!==0){i.options[j].value=k.text()}else{i.options[j].value=k.text()}$(i).trigger("change",{keepAnswer:m.keepAnswer})},100)}).each(function(i,j){j.title=$(j).text()});this.$selects.change(g.proxy(function(j,i){i=i||{};setTimeout(g.proxy(function(){var m=j.target;var l=$(j.target);var k=$(m.options[m.selectedIndex]);if(k.attr("_role")){}else{this.onSelectQuestion(l,k,{keepAnswer:i.keepAnswer})}},this),50)},this));this.$form.find(".submit_btn").click(g.proxy(function(){this.$form.submit()},this));this.$form.submit(g.proxy(this.onSubmit,this));var h=this.$form.find(".i_currentselected");h.click(function(j){var i=j.target;h.each(function(k,l){if(l!==i){$(l.parentNode).find(".i_selectoption").hide()}})})},render:function(){var m=$(this.$selects[0]);var k=m.find("optgroup");var h=this.typeMap;k.each(g.proxy(function(o,q){var n=$(q);var p=n.attr("_type");h[p]=0},this));var j=window.pageData||window.mibaoData;if(j){$.each(j.list,g.proxy(function(s,x){var u=this.$selects[s],n=$(u);var p=$(u).find("option");var y=false;var t=-(s+1);var w;p.each(function(z,A){if(A.value&&A.text===x.q){y=true;w=A;return false}});if(!y){var q=$(u).find("option[_role=default]");q.attr("value",x.q).text(x.q)}else{var r=w.parentNode.getAttribute("_type");h[r]++}var v=$('<optgroup label="'+d.getResource("existing_question")+'" _type="'+t+'"></optgroup>').append("<option></option>");var o=v.find("option");o.text(x.q).attr({_answerTip:"",value:x.q});v.prependTo(u);n.find(".def-opt").remove()},this))}this.$selects.iSimulateSelect();this.$selects.each(g.proxy(function(p,n){var o=$(n);var q=0;var r=o.find("optgroup");r.each(g.proxy(function(w,y){var v=$(y);var x=v.attr("_type");var t=v.find("option");var s=v.closest(".login-dl").find(".i_selectoption").find("dd");var u=$(v.closest(".login-dl").find(".i_selectoption").find("dt")[w]);u.attr("_type",x);t.each(function(z,B){var A=$(s[q+z]);var C=$(B);A.attr("_type",x);if(B.className){A.addClass(B.className)}});q+=t.size()},this))},this));this.uiBind();if(j){var i=false;$.each(j.list,g.proxy(function(r,s){var p=this.$selects[r];var q=$(p);var o=q.find("option");if(j.reset||j.update){if(s.a){q.closest(".login-dl").find(".input_kuang").val(s.a)}}if(s.m){q.closest(".login-dl").find(".error-mes").text(s.m).show()}else{q.closest(".login-dl").find(".error-mes").text("").hide()}var n=true;o.each(g.proxy(function(t,u){var v=u.text;if(v===s.q){$(q.parent().find(".i_selectoption dd")[t]).trigger("click",{keepAnswer:j.reset||j.update});n=false;return false}},this));i=i||n},this))}var l={};$.each(h,function(n,o){l[n]=o});setTimeout(g.proxy(function(){this.updateQuestionDisplay({typeMap:l})},this),500);this.$form[0].elements.mibao_ph.value=b.get("mibao_ph")||"";this.$form[0].elements.serviceToken.value=b.get("serviceToken")||"";if(j&&j.update){this.$form.append($('<input type="hidden" name="update" value="true"/>'))}},onSelectQuestion:function(j,h,i){j.closest(".login-dl").find(".i_currentselected").attr("title",h.text());var k=j.closest(".login-dl").find(".input_kuang");k.attr("placeholder",h.attr("_answerTip")||"");i=i||{};if(!i.keepAnswer){k.val("")}this.updateQuestionDisplay();j.closest("dl").find(".error-mes").hide();j.closest("dl").find(".error_bg").removeClass("error_bg")},onUnselectQuestion:function(h){var i=h.closest(".select-area").find(".input_kuang");i.attr("placeholder","");i.val("");this.updateQuestionDisplay()},updateQuestionDisplay:function(i){i=i||{};if(!i.typeMap){$.each(this.typeMap,g.proxy(function(l,m){this.typeMap[l]=0},this))}else{this.typeMap=i.typeMap}$.each(this.questionMap,g.proxy(function(l,m){this.questionMap[l]=0},this));this.$selects.each(g.proxy(function(m,l){var o=l.options[l.selectedIndex];var n=o.parentNode.getAttribute("_type");var p=o.getAttribute("_role");if(!p){if(!i.typeMap){this.typeMap[n]++}}if(l.value){if(this.questionMap.hasOwnProperty(o.text)){this.questionMap[o.text]++}else{this.questionMap[o.text]=1}}},this));var h=this.constructor.typeLimit;var k=this.typeMap;var j=this.questionMap;this.$selects.each(g.proxy(function(o,m){var r=m.options[m.selectedIndex];var q,p="-10";if($(r).hasClass("def-opt")){q=""}else{q=r.parentNode.getAttribute("_type")}var n=$(m);var s=n.find("optgroup");s.each(function(u,x){var v=x.getAttribute("_type"),t=$(x).find(" > option");if(+v<0){return}var w=false;t.each(function(y,z){if(z.text===r.text&&v!=0){w=true;return false}});if(w){p=v;return false}});s.each(function(t,v){var u=v.getAttribute("_type");var w=n.parent().find(".i_selectoption");if(k[u]>=h&&u!==q&&p!==u){w.find("[_type='"+u+"']:not(.def-opt)").hide()}else{w.find("[_type='"+u+"']:not(.def-opt)").show()}});var l=n.find("option");l.each(function(t,u){var v=u.text;if(j.hasOwnProperty(v)&&j[v]&&v!==r.text){$(n.parent().find(".i_selectoption").find("dd")[t]).hide()}})},this))},serialize:function(){var h=[];this.$selects.each(g.proxy(function(j,k){var i=$(k);$answer=i.closest(".login-dl").find(".input_kuang");h.push('{"q":"'+this.constructor.addSlashes(i.val())+'","a":"'+this.constructor.addSlashes($answer.val())+'"}')},this));return"["+h.join(",")+"]"},clearErrorAt:function(h){this.showErrorAt(h,"");this.showErrorAt(h,"",false);return this},showErrorAt:function(i,l,j){var k=$(this.$selects[i]);var h=k.closest(".login-dl").find(".error-mes");h.text(l);if(l){h.show();if(!j){h.closest("dl").find(".input_bg").addClass("error_bg")}else{h.closest("dl").find(".i_currentselected").addClass("error_bg")}}else{h.hide();if(!j){h.closest("dl").find(".input_bg").removeClass("error_bg")}else{h.closest("dl").find(".i_currentselected").removeClass("error_bg")}}},showGlobalError:function(h){this.$form.find(".tl_c .form-error-mes").text(h).show()},clearGlobalError:function(){this.$form.find(".tl_c .form-error-mes").text("").hide()},slim:function(){this.$selects.remove();this.$form.find(".input_kuang").remove()},validate:function(){var h=false,i={};this.$selects.each(g.proxy(function(k,j){var l=false;var n=j.value;var m=$(j).closest(".login-dl").find(".input_kuang").val();if(!n){this.showErrorAt(k,d.getResource("question_empty"),true);l=true}else{if(i.hasOwnProperty(m)){this.showErrorAt(k,d.getResource("answer_same"));l=true}else{i[m]=true}if(m.length<2){this.showErrorAt(k,d.getResource("answer_too_short"));l=true}if(!m){this.showErrorAt(k,d.getResource("answer_empty"));l=true}if(m.length>128){this.showErrorAt(k,d.getResource("answer_too_long"));l=true}if(!l){this.clearErrorAt(k)}}h=h||l},this));return !h},onSubmit:function(i){if(!this.validate()){i.stopImmediatePropagation();i.preventDefault();return false}if(this.ajax){i.preventDefault()}var h=this.serialize();this.$form.find(".form-data").val(h)}},{statics:{addSlashes:function(h){return(h+"").replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},typeLimit:2}});var a=g.$class({constructor:function(h){this.$form=$(h.form||h.$form);this.$inputs=this.$form.find(".input_kuang");this.$errorBox=this.$form.find(".check_tips");this.$secretArea=this.$form.find(".secret-area")},retryPeriod:3600*1000,retriesPerPeriod:5,retryCookieName:"mb_quota",retryTimeCookieName:"mb_rt",render:function(){this.uiBind();var j=b.get(this.retryCookieName);var i;if(!j){j=this.retriesPerPeriod;i=+new Date+this.retryPeriod;b.remove(this.retryTimeCookieName)}else{j=parseInt(j,10);i=parseInt(b.get(this.retryTimeCookieName),10)||(+new Date+this.retryPeriod)}var h=window.pageData||window.mibaoData;if(h){if(h.wrongAnswer){j--}if(h.offLimit){this.disable(d.getResource("retry_after"));j=0}}this.$form[0].elements.passport_ph.value=b.get("passport_ph")||"";this.$form[0].elements.serviceToken.value=b.get("serviceToken")||"";if(j<=0){this.disable(d.getResource("retry_after"));j=0}else{if(h.wrongAnswer){this.showError(d.getResource("wrong_answer")+d.getResource("time_left").replace(/<span class='color_yellow'>.*?<\/span>/,"<span class='color_yellow'>"+j+"</span>"))}}b.set(this.retryCookieName,j,{expires:new Date(i)});b.set(this.retryTimeCookieName,i,{expires:b.FAR_FUTURE})},uiBind:function(){var h=arguments.callee.called;if(h){return}arguments.callee.called=true;this.$form.find(".input_bg input").bind("focus",function(i){$(i.target).closest("li").find(".error-mes").hide()});this.$form.submit(g.proxy(this.onSubmit,this))},serialize:function(){var h=[];this.$inputs.each(g.proxy(function(j,k){var i=$(k);$answer=i.parent().find("span");h.push('{"q":"'+this.constructor.addSlashes($answer.html())+'","a":"'+this.constructor.addSlashes(i.val())+'","p":"'+(i.attr("_position")||"")+'"}')},this));return"["+h.join(",")+"]"},onSubmit:function(i){if(!this.validate()){return false}var h=this.serialize();this.$form.find(".form-data").val(h);if(this.ajax){i.preventDefault();return false}},disable:function(h){this.$secretArea.addClass("disabled");this.$inputs.attr("disabled","disabled");if(h){this.showError(h)}},enable:function(){this.$secretArea.removeClass("disabled");this.$inputs.removeAttr("disabled");this.clearError()},validate:function(){var h=false;if(this.$secretArea.hasClass("disabled")){return false}this.$inputs.each(g.proxy(function(j,i){if(!i.value){this.showError(d.getResource("answer_empty"));h=true}else{if(i.value.length>128){this.showError(d.getResource("answer_too_long"));h=true}}if(h){i.focus();return false}},this));return !h},showError:function(h){this.$errorBox.css("display","block").html(h)},clearError:function(){this.$errorBox.hide().html("")}},{statics:{addSlashes:function(h){return(h+"").replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0")},typeLimit:2}});var c=g.$class({constructor:function(h){}});return{QuestionForm:f,AnswerForm:a,Question:e,Mibao:c}});